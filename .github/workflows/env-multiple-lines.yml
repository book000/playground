name: Env multiple lines

on:
  workflow_dispatch:

env:
  TARGETS: >-
    [
      { imageName: "tomacheese/my-pixiv", file: "view.Dockerfile", packageName: "my-pixiv" },
      { imageName: "tomacheese/my-pixiv-api", file: "api.Dockerfile", packageName: "my-pixiv-api" }
    ]
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  pre:
    runs-on: ubuntu-latest

    outputs:
      targets: ${{ steps.targets.outputs.targets }}

    steps:
      - name: Create targets
        id: targets
        uses: actions/github-script@v6
        with:
          script: |
            core.setOutput('targets', process.env.TARGETS)
        env:
          TARGETS: ${{ env.TARGETS }}

  test:
    runs-on: ubuntu-latest

    needs:
      - pre

    strategy:
      matrix:
        target: ${{ fromJSON( needs.pre.outputs.targets ) }}

    steps:
      - name: Test
        run: |
          echo ${{ matrix.target.packageName }}

      - name: Test 3
        run: |
          echo "matrix=[$(echo "$PLATFORMS" | sed -r -e 's/([^,]+)/\"\1\"/g' -e 's/([^,]+),/\1,/g')]"
